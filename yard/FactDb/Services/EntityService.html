<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: FactDb::Services::EntityService
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "FactDb::Services::EntityService";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (E)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../FactDb.html" title="FactDb (module)">FactDb</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Services.html" title="FactDb::Services (module)">Services</a></span></span>
     &raquo; 
    <span class="title">EntityService</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: FactDb::Services::EntityService
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">FactDb::Services::EntityService</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/fact_db/services/entity_service.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Service class for managing entities in the database</p>

<p>Provides methods for creating, searching, and managing entities including name resolution, alias management, and duplicate detection.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'>
<p>Basic usage</p>
</div></h5>
      
      <pre class="example code"><code><span class='id identifier rubyid_service'>service</span> <span class='op'>=</span> <span class='const'>EntityService</span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="#initialize-instance_method" title="FactDb::Services::EntityService#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_entity'>entity</span> <span class='op'>=</span> <span class='id identifier rubyid_service'>service</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>John Smith</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='symbol'>:person</span><span class='rparen'>)</span></code></pre>
    
  </div>


</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#config-instance_method" title="#config (instance method)">#<strong>config</strong>  &#x21d2; FactDb::Config </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The configuration object.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolver-instance_method" title="#resolver (instance method)">#<strong>resolver</strong>  &#x21d2; FactDb::Resolution::EntityResolver </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The entity resolver instance.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_alias-instance_method" title="#add_alias (instance method)">#<strong>add_alias</strong>(entity_id, alias_name, kind: nil, confidence: 1.0)  &#x21d2; FactDb::Models::EntityAlias </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds an alias to an entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#auto_merge_duplicates!-instance_method" title="#auto_merge_duplicates! (instance method)">#<strong>auto_merge_duplicates!</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Automatically merges high-confidence duplicates.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#by_kind-instance_method" title="#by_kind (instance method)">#<strong>by_kind</strong>(kind)  &#x21d2; ActiveRecord::Relation </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns entities of a specific kind.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">#<strong>create</strong>(name, kind:, aliases: [], attributes: {}, description: nil)  &#x21d2; FactDb::Models::Entity </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a new entity in the database.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#facts_about-instance_method" title="#facts_about (instance method)">#<strong>facts_about</strong>(entity_id, at: nil, status: :canonical)  &#x21d2; ActiveRecord::Relation </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns facts about an entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find-instance_method" title="#find (instance method)">#<strong>find</strong>(id)  &#x21d2; FactDb::Models::Entity </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Finds an entity by ID.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find_by_name-instance_method" title="#find_by_name (instance method)">#<strong>find_by_name</strong>(name, kind: nil)  &#x21d2; FactDb::Models::Entity<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Finds an entity by exact name match.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find_duplicates-instance_method" title="#find_duplicates (instance method)">#<strong>find_duplicates</strong>(threshold: nil)  &#x21d2; Array&lt;Hash&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Finds potential duplicate entities.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fuzzy_search-instance_method" title="#fuzzy_search (instance method)">#<strong>fuzzy_search</strong>(query, kind: nil, threshold: 0.3, limit: 20)  &#x21d2; Array&lt;FactDb::Models::Entity&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Searches entities using PostgreSQL trigram similarity (handles typos).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(config = FactDb.config)  &#x21d2; EntityService </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initializes a new EntityService instance.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#merge-instance_method" title="#merge (instance method)">#<strong>merge</strong>(keep_id, merge_id)  &#x21d2; FactDb::Models::Entity </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Merges two entities, keeping one as canonical.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#relationship_types-instance_method" title="#relationship_types (instance method)">#<strong>relationship_types</strong>  &#x21d2; Array&lt;Symbol&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns all relationship types used in the database.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#relationship_types_for-instance_method" title="#relationship_types_for (instance method)">#<strong>relationship_types_for</strong>(entity_id)  &#x21d2; Array&lt;Symbol&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns relationship types for a specific entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolve-instance_method" title="#resolve (instance method)">#<strong>resolve</strong>(name, kind: nil)  &#x21d2; FactDb::Resolution::ResolvedEntity<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Resolves a name to an existing entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#resolve_or_create-instance_method" title="#resolve_or_create (instance method)">#<strong>resolve_or_create</strong>(name, kind:, aliases: [], attributes: {}, description: nil)  &#x21d2; FactDb::Models::Entity </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Resolves a name to an entity, creating one if not found.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search-instance_method" title="#search (instance method)">#<strong>search</strong>(query, kind: nil, limit: 20)  &#x21d2; ActiveRecord::Relation </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Searches entities by name or alias using LIKE pattern matching.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#semantic_search-instance_method" title="#semantic_search (instance method)">#<strong>semantic_search</strong>(query, kind: nil, limit: 20)  &#x21d2; ActiveRecord::Relation </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Searches entities using semantic similarity (vector search).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stats-instance_method" title="#stats (instance method)">#<strong>stats</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns aggregate statistics about entities.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#timeline_for-instance_method" title="#timeline_for (instance method)">#<strong>timeline_for</strong>(entity_id, from: nil, to: nil)  &#x21d2; FactDb::Temporal::Timeline </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Builds a timeline of facts for an entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#timespan_for-instance_method" title="#timespan_for (instance method)">#<strong>timespan_for</strong>(entity_id)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the timespan of facts for an entity.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(config = FactDb.config)  &#x21d2; <tt><span class='object_link'><a href="" title="FactDb::Services::EntityService (class)">EntityService</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initializes a new EntityService instance</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>config</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Config.html" title="FactDb::Config (class)">FactDb::Config</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>FactDb.config</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>configuration object (defaults to FactDb.config)</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


24
25
26
27</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 24</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../FactDb.html" title="FactDb (module)">FactDb</a></span></span><span class='period'>.</span><span class='id identifier rubyid_config'><span class='object_link'><a href="../../FactDb.html#config-class_method" title="FactDb.config (method)">config</a></span></span><span class='rparen'>)</span>
  <span class='ivar'>@config</span> <span class='op'>=</span> <span class='id identifier rubyid_config'>config</span>
  <span class='ivar'>@resolver</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Resolution.html" title="FactDb::Resolution (module)">Resolution</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Resolution/EntityResolver.html" title="FactDb::Resolution::EntityResolver (class)">EntityResolver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Resolution/EntityResolver.html#initialize-instance_method" title="FactDb::Resolution::EntityResolver#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="config-instance_method">
  
    #<strong>config</strong>  &#x21d2; <tt><span class='object_link'><a href="../Config.html" title="FactDb::Config (class)">FactDb::Config</a></span></tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the configuration object.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Config.html" title="FactDb::Config (class)">FactDb::Config</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the configuration object</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


16
17
18</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 16</span>

<span class='kw'>def</span> <span class='id identifier rubyid_config'>config</span>
  <span class='ivar'>@config</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="resolver-instance_method">
  
    #<strong>resolver</strong>  &#x21d2; <tt><span class='object_link'><a href="../Resolution/EntityResolver.html" title="FactDb::Resolution::EntityResolver (class)">FactDb::Resolution::EntityResolver</a></span></tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the entity resolver instance.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resolution/EntityResolver.html" title="FactDb::Resolution::EntityResolver (class)">FactDb::Resolution::EntityResolver</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity resolver instance</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


19
20
21</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 19</span>

<span class='kw'>def</span> <span class='id identifier rubyid_resolver'>resolver</span>
  <span class='ivar'>@resolver</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_alias-instance_method">
  
    #<strong>add_alias</strong>(entity_id, alias_name, kind: nil, confidence: 1.0)  &#x21d2; <tt><span class='object_link'><a href="../Models/EntityAlias.html" title="FactDb::Models::EntityAlias (class)">FactDb::Models::EntityAlias</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Adds an alias to an entity</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>entity_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity ID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>alias_name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the alias text</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>alias kind</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>confidence</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>1.0</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>confidence score</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Models/EntityAlias.html" title="FactDb::Models::EntityAlias (class)">FactDb::Models::EntityAlias</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the created alias</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


141
142
143
144</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 141</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_alias'>add_alias</span><span class='lparen'>(</span><span class='id identifier rubyid_entity_id'>entity_id</span><span class='comma'>,</span> <span class='id identifier rubyid_alias_name'>alias_name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>confidence:</span> <span class='float'>1.0</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_entity'>entity</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_entity_id'>entity_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_entity'>entity</span><span class='period'>.</span><span class='id identifier rubyid_add_alias'>add_alias</span><span class='lparen'>(</span><span class='id identifier rubyid_alias_name'>alias_name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='comma'>,</span> <span class='label'>confidence:</span> <span class='id identifier rubyid_confidence'>confidence</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="auto_merge_duplicates!-instance_method">
  
    #<strong>auto_merge_duplicates!</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Automatically merges high-confidence duplicates</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


281
282
283</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 281</span>

<span class='kw'>def</span> <span class='id identifier rubyid_auto_merge_duplicates!'>auto_merge_duplicates!</span>
  <span class='ivar'>@resolver</span><span class='period'>.</span><span class='id identifier rubyid_auto_merge_duplicates!'>auto_merge_duplicates!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="by_kind-instance_method">
  
    #<strong>by_kind</strong>(kind)  &#x21d2; <tt>ActiveRecord::Relation</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns entities of a specific kind</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity kind</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>ActiveRecord::Relation</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>entities of that kind</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


242
243
244</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 242</span>

<span class='kw'>def</span> <span class='id identifier rubyid_by_kind'>by_kind</span><span class='lparen'>(</span><span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_by_kind'><span class='object_link'><a href="../Models/Entity.html#by_kind-instance_method" title="FactDb::Models::Entity#by_kind (method)">by_kind</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_not_merged'>not_merged</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span><span class='lparen'>(</span><span class='symbol'>:name</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create-instance_method">
  
    #<strong>create</strong>(name, kind:, aliases: [], attributes: {}, description: nil)  &#x21d2; <tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a new entity in the database</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the canonical name</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>entity kind (:person, :organization, etc.)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>aliases</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>[]</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>alternative names</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>attributes</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>additional metadata attributes</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>description</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>entity description</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the created entity</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 37</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span><span class='comma'>,</span> <span class='label'>aliases:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>attributes:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>description:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_embedding'>embedding</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_embedding'>generate_embedding</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_entity'>entity</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create!'>create!</span><span class='lparen'>(</span>
    <span class='label'>name:</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span>
    <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
    <span class='label'>description:</span> <span class='id identifier rubyid_description'>description</span><span class='comma'>,</span>
    <span class='label'>metadata:</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span>
    <span class='label'>resolution_status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>resolved</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>embedding:</span> <span class='id identifier rubyid_embedding'>embedding</span>
  <span class='rparen'>)</span>

  <span class='id identifier rubyid_aliases'>aliases</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_alias_text'>alias_text</span><span class='op'>|</span>
    <span class='id identifier rubyid_entity'>entity</span><span class='period'>.</span><span class='id identifier rubyid_add_alias'>add_alias</span><span class='lparen'>(</span><span class='id identifier rubyid_alias_text'>alias_text</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_entity'>entity</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="facts_about-instance_method">
  
    #<strong>facts_about</strong>(entity_id, at: nil, status: :canonical)  &#x21d2; <tt>ActiveRecord::Relation</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns facts about an entity</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>entity_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity ID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>at</span>
      
      
        <span class='type'>(<tt>Date</tt>, <tt>Time</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>optional point in time</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>status</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>:canonical</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>fact status filter</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>ActiveRecord::Relation</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>facts mentioning the entity</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


252
253
254
255
256
257
258</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 252</span>

<span class='kw'>def</span> <span class='id identifier rubyid_facts_about'>facts_about</span><span class='lparen'>(</span><span class='id identifier rubyid_entity_id'>entity_id</span><span class='comma'>,</span> <span class='label'>at:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:canonical</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Temporal.html" title="FactDb::Temporal (module)">Temporal</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Temporal/Query.html" title="FactDb::Temporal::Query (class)">Query</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Temporal/Query.html#initialize-instance_method" title="FactDb::Temporal::Query#initialize (method)">new</a></span></span><span class='period'>.</span><span class='id identifier rubyid_execute'><span class='object_link'><a href="../Temporal/Query.html#execute-instance_method" title="FactDb::Temporal::Query#execute (method)">execute</a></span></span><span class='lparen'>(</span>
    <span class='label'>entity_id:</span> <span class='id identifier rubyid_entity_id'>entity_id</span><span class='comma'>,</span>
    <span class='label'>at:</span> <span class='id identifier rubyid_at'>at</span><span class='comma'>,</span>
    <span class='label'>status:</span> <span class='id identifier rubyid_status'>status</span>
  <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="find-instance_method">
  
    #<strong>find</strong>(id)  &#x21d2; <tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Finds an entity by ID</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity ID</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the found entity</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ActiveRecord::RecordNotFound</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>if entity not found</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="find_by_name-instance_method">
  
    #<strong>find_by_name</strong>(name, kind: nil)  &#x21d2; <tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Finds an entity by exact name match</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity name (case-insensitive)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>optional kind filter</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the found entity or nil</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


70
71
72
73
74</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 70</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find_by_name'>find_by_name</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LOWER(name) = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_kind'>kind</span>
  <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_not_merged'>not_merged</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="find_duplicates-instance_method">
  
    #<strong>find_duplicates</strong>(threshold: nil)  &#x21d2; <tt>Array&lt;Hash&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Finds potential duplicate entities</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>threshold</span>
      
      
        <span class='type'>(<tt>Float</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>minimum similarity score</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Hash&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>array of potential duplicates</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


274
275
276</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 274</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find_duplicates'>find_duplicates</span><span class='lparen'>(</span><span class='label'>threshold:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@resolver</span><span class='period'>.</span><span class='id identifier rubyid_find_duplicates'>find_duplicates</span><span class='lparen'>(</span><span class='label'>threshold:</span> <span class='id identifier rubyid_threshold'>threshold</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fuzzy_search-instance_method">
  
    #<strong>fuzzy_search</strong>(query, kind: nil, threshold: 0.3, limit: 20)  &#x21d2; <tt>Array&lt;<span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span>&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Searches entities using PostgreSQL trigram similarity (handles typos)</p>

<p>Requires pg_trgm extension. Falls back to LIKE search if unavailable.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>query</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>search term (minimum 3 characters)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>optional kind filter</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>threshold</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0.3</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>minimum similarity score (0.0-1.0)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>limit</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>20</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>maximum number of results</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;<span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span>&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>entities ordered by similarity</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 192</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fuzzy_search'>fuzzy_search</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>threshold:</span> <span class='float'>0.3</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='int'>20</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='int'>3</span>

  <span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;~SQL</span>
<span class='tstring_content'>    SELECT DISTINCT e.id,
</span><span class='tstring_content'>           GREATEST(
</span><span class='tstring_content'>             similarity(LOWER(e.name), LOWER(?)),
</span><span class='tstring_content'>             COALESCE(MAX(similarity(LOWER(a.name), LOWER(?))), 0)
</span><span class='tstring_content'>           ) as sim_score
</span><span class='tstring_content'>    FROM fact_db_entities e
</span><span class='tstring_content'>    LEFT JOIN fact_db_entity_aliases a ON a.entity_id = e.id
</span><span class='tstring_content'>    WHERE e.resolution_status != &#39;merged&#39;
</span><span class='tstring_content'>      AND (
</span><span class='tstring_content'>        similarity(LOWER(e.name), LOWER(?)) &gt; ?
</span><span class='tstring_content'>        OR similarity(LOWER(a.name), LOWER(?)) &gt; ?
</span><span class='tstring_content'>      )
</span><span class='tstring_content'>    GROUP BY e.id
</span><span class='tstring_content'>    ORDER BY sim_score DESC
</span><span class='tstring_content'>    LIMIT ?
</span><span class='heredoc_end'>  SQL
</span>
  <span class='id identifier rubyid_sanitized'>sanitized</span> <span class='op'>=</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_sanitize_sql'>sanitize_sql</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_threshold'>threshold</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_threshold'>threshold</span><span class='comma'>,</span> <span class='id identifier rubyid_limit'>limit</span><span class='rbracket'>]</span>
  <span class='rparen'>)</span>

  <span class='id identifier rubyid_results'>results</span> <span class='op'>=</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_sanitized'>sanitized</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_entity_ids'>entity_ids</span> <span class='op'>=</span> <span class='id identifier rubyid_results'>results</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>

  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_entity_ids'>entity_ids</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='comment'># Preserve ordering by fetching in order
</span>  <span class='id identifier rubyid_entities_by_id'>entities_by_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>id:</span> <span class='id identifier rubyid_entity_ids'>entity_ids</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_index_by'>index_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ordered_entities'>ordered_entities</span> <span class='op'>=</span> <span class='id identifier rubyid_entity_ids'>entity_ids</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_id'>id</span><span class='op'>|</span> <span class='id identifier rubyid_entities_by_id'>entities_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>

  <span class='comment'># Apply kind filter if specified
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_kind'>kind</span>
    <span class='id identifier rubyid_ordered_entities'>ordered_entities</span> <span class='op'>=</span> <span class='id identifier rubyid_ordered_entities'>ordered_entities</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_kind'>kind</span> <span class='op'>==</span> <span class='id identifier rubyid_kind'>kind</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_ordered_entities'>ordered_entities</span>
<span class='kw'>rescue</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>StatementInvalid</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='comment'># pg_trgm extension not available, fall back to LIKE search
</span>  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='op'>&amp;.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fuzzy search unavailable (pg_trgm not installed): </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='id identifier rubyid_limit'>limit</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="merge-instance_method">
  
    #<strong>merge</strong>(keep_id, merge_id)  &#x21d2; <tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Merges two entities, keeping one as canonical</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>keep_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>ID of the entity to keep</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>merge_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>ID of the entity to merge</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the kept entity</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


130
131
132</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 130</span>

<span class='kw'>def</span> <span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_keep_id'>keep_id</span><span class='comma'>,</span> <span class='id identifier rubyid_merge_id'>merge_id</span><span class='rparen'>)</span>
  <span class='ivar'>@resolver</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_keep_id'>keep_id</span><span class='comma'>,</span> <span class='id identifier rubyid_merge_id'>merge_id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="relationship_types-instance_method">
  
    #<strong>relationship_types</strong>  &#x21d2; <tt>Array&lt;Symbol&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns all relationship types used in the database</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Symbol&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>relationship types (mention roles)</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


302
303
304</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 302</span>

<span class='kw'>def</span> <span class='id identifier rubyid_relationship_types'>relationship_types</span>
  <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/EntityMention.html" title="FactDb::Models::EntityMention (class)">EntityMention</a></span></span><span class='period'>.</span><span class='id identifier rubyid_distinct'>distinct</span><span class='period'>.</span><span class='id identifier rubyid_pluck'>pluck</span><span class='lparen'>(</span><span class='symbol'>:mention_role</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_sym</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="relationship_types_for-instance_method">
  
    #<strong>relationship_types_for</strong>(entity_id)  &#x21d2; <tt>Array&lt;Symbol&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns relationship types for a specific entity</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>entity_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Entity ID</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Symbol&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Relationship types for this entity</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


310
311
312
313
314
315
316
317</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 310</span>

<span class='kw'>def</span> <span class='id identifier rubyid_relationship_types_for'>relationship_types_for</span><span class='lparen'>(</span><span class='id identifier rubyid_entity_id'>entity_id</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/EntityMention.html" title="FactDb::Models::EntityMention (class)">EntityMention</a></span></span>
    <span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>entity_id:</span> <span class='id identifier rubyid_entity_id'>entity_id</span><span class='rparen'>)</span>
    <span class='period'>.</span><span class='id identifier rubyid_distinct'>distinct</span>
    <span class='period'>.</span><span class='id identifier rubyid_pluck'>pluck</span><span class='lparen'>(</span><span class='symbol'>:mention_role</span><span class='rparen'>)</span>
    <span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
    <span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_sym</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="resolve-instance_method">
  
    #<strong>resolve</strong>(name, kind: nil)  &#x21d2; <tt><span class='object_link'><a href="../Resolution/ResolvedEntity.html" title="FactDb::Resolution::ResolvedEntity (class)">FactDb::Resolution::ResolvedEntity</a></span></tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Resolves a name to an existing entity</p>

<p>Uses exact alias matching, canonical name matching, and fuzzy matching.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the name to resolve</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>optional kind filter</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Resolution/ResolvedEntity.html" title="FactDb::Resolution::ResolvedEntity (class)">FactDb::Resolution::ResolvedEntity</a></span></tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>resolved entity or nil</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


83
84
85</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 83</span>

<span class='kw'>def</span> <span class='id identifier rubyid_resolve'>resolve</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@resolver</span><span class='period'>.</span><span class='id identifier rubyid_resolve'>resolve</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="resolve_or_create-instance_method">
  
    #<strong>resolve_or_create</strong>(name, kind:, aliases: [], attributes: {}, description: nil)  &#x21d2; <tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Resolves a name to an entity, creating one if not found</p>

<p>Also checks if any provided aliases match existing entities.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the name to resolve or create</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>entity kind (required for creation)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>aliases</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>[]</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>additional aliases</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>attributes</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>additional attributes for new entity</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>description</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>entity description</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">FactDb::Models::Entity</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the resolved or created entity</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 97</span>

<span class='kw'>def</span> <span class='id identifier rubyid_resolve_or_create'>resolve_or_create</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span><span class='comma'>,</span> <span class='label'>aliases:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>attributes:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>description:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># First, try to resolve the canonical name
</span>  <span class='id identifier rubyid_resolved'>resolved</span> <span class='op'>=</span> <span class='ivar'>@resolver</span><span class='period'>.</span><span class='id identifier rubyid_resolve'>resolve</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_resolved'>resolved</span>
    <span class='comment'># Add any new aliases to the resolved entity
</span>    <span class='id identifier rubyid_add_new_aliases'>add_new_aliases</span><span class='lparen'>(</span><span class='id identifier rubyid_resolved'>resolved</span><span class='period'>.</span><span class='id identifier rubyid_entity'>entity</span><span class='comma'>,</span> <span class='id identifier rubyid_aliases'>aliases</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_resolved'>resolved</span><span class='period'>.</span><span class='id identifier rubyid_entity'>entity</span>
  <span class='kw'>end</span>

  <span class='comment'># Check if any of the provided aliases match an existing entity
</span>  <span class='comment'># This handles cases like: name=&quot;Lord&quot;, aliases=[&quot;Jesus&quot;] where &quot;Jesus&quot; already exists
</span>  <span class='id identifier rubyid_aliases'>aliases</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_alias_text'>alias_text</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_alias_text'>alias_text</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

    <span class='id identifier rubyid_resolved_by_alias'>resolved_by_alias</span> <span class='op'>=</span> <span class='ivar'>@resolver</span><span class='period'>.</span><span class='id identifier rubyid_resolve'>resolve</span><span class='lparen'>(</span><span class='id identifier rubyid_alias_text'>alias_text</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_resolved_by_alias'>resolved_by_alias</span>
      <span class='id identifier rubyid_entity'>entity</span> <span class='op'>=</span> <span class='id identifier rubyid_resolved_by_alias'>resolved_by_alias</span><span class='period'>.</span><span class='id identifier rubyid_entity'>entity</span>
      <span class='comment'># Add the new canonical name as an alias to the existing entity
</span>      <span class='id identifier rubyid_entity'>entity</span><span class='period'>.</span><span class='id identifier rubyid_add_alias'>add_alias</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_entity'>entity</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>==</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
      <span class='comment'># Add all the other aliases too
</span>      <span class='id identifier rubyid_add_new_aliases'>add_new_aliases</span><span class='lparen'>(</span><span class='id identifier rubyid_entity'>entity</span><span class='comma'>,</span> <span class='id identifier rubyid_aliases'>aliases</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_entity'>entity</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='comma'>,</span> <span class='label'>aliases:</span> <span class='id identifier rubyid_aliases'>aliases</span><span class='comma'>,</span> <span class='label'>attributes:</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='comma'>,</span> <span class='label'>description:</span> <span class='id identifier rubyid_description'>description</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="search-instance_method">
  
    #<strong>search</strong>(query, kind: nil, limit: 20)  &#x21d2; <tt>ActiveRecord::Relation</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Searches entities by name or alias using LIKE pattern matching</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>query</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the search query</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>optional kind filter</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>limit</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>20</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>maximum number of results</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>ActiveRecord::Relation</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>matching entities</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


152
153
154
155
156
157
158
159
160
161
162
163
164</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 152</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='int'>20</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_not_merged'><span class='object_link'><a href="../Models/Entity.html#not_merged-instance_method" title="FactDb::Models::Entity#not_merged (method)">not_merged</a></span></span>

  <span class='comment'># Search canonical names and aliases
</span>  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_left_joins'>left_joins</span><span class='lparen'>(</span><span class='symbol'>:aliases</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LOWER(fact_db_entities.name) LIKE ? OR LOWER(fact_db_entity_aliases.name) LIKE ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span>
  <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_distinct'>distinct</span>

  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_kind'>kind</span>
  <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_limit'>limit</span><span class='lparen'>(</span><span class='id identifier rubyid_limit'>limit</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="semantic_search-instance_method">
  
    #<strong>semantic_search</strong>(query, kind: nil, limit: 20)  &#x21d2; <tt>ActiveRecord::Relation</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Searches entities using semantic similarity (vector search)</p>

<p>Requires an embedding generator to be configured.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>query</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the search query</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kind</span>
      
      
        <span class='type'>(<tt>Symbol</tt>, <tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>optional kind filter</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>limit</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>20</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>maximum number of results</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>ActiveRecord::Relation</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>semantically similar entities</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


174
175
176
177
178
179
180
181</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 174</span>

<span class='kw'>def</span> <span class='id identifier rubyid_semantic_search'>semantic_search</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='label'>kind:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='int'>20</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_embedding'>embedding</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_embedding'>generate_embedding</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_none'>none</span> <span class='kw'>unless</span> <span class='id identifier rubyid_embedding'>embedding</span>

  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_not_merged'><span class='object_link'><a href="../Models/Entity.html#not_merged-instance_method" title="FactDb::Models::Entity#not_merged (method)">not_merged</a></span></span><span class='period'>.</span><span class='id identifier rubyid_nearest_neighbors'>nearest_neighbors</span><span class='lparen'>(</span><span class='id identifier rubyid_embedding'>embedding</span><span class='comma'>,</span> <span class='label'>limit:</span> <span class='id identifier rubyid_limit'>limit</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_scope'>scope</span> <span class='op'>=</span> <span class='id identifier rubyid_scope'>scope</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>kind:</span> <span class='id identifier rubyid_kind'>kind</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_kind'>kind</span>
  <span class='id identifier rubyid_scope'>scope</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stats-instance_method">
  
    #<strong>stats</strong>  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns aggregate statistics about entities</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>statistics including counts by kind and status</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


288
289
290
291
292
293
294
295
296
297</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 288</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stats'>stats</span>
  <span class='lbrace'>{</span>
    <span class='label'>total:</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_not_merged'><span class='object_link'><a href="../Models/Entity.html#not_merged-instance_method" title="FactDb::Models::Entity#not_merged (method)">not_merged</a></span></span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span>
    <span class='label'>total_count:</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_not_merged'><span class='object_link'><a href="../Models/Entity.html#not_merged-instance_method" title="FactDb::Models::Entity#not_merged (method)">not_merged</a></span></span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span>
    <span class='label'>by_kind:</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_not_merged'><span class='object_link'><a href="../Models/Entity.html#not_merged-instance_method" title="FactDb::Models::Entity#not_merged (method)">not_merged</a></span></span><span class='period'>.</span><span class='id identifier rubyid_group'>group</span><span class='lparen'>(</span><span class='symbol'>:kind</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span>
    <span class='label'>by_status:</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_group'>group</span><span class='lparen'>(</span><span class='symbol'>:resolution_status</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span>
    <span class='label'>merged_count:</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>resolution_status:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>merged</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span>
    <span class='label'>with_facts:</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Entity.html" title="FactDb::Models::Entity (class)">Entity</a></span></span><span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:entity_mentions</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_distinct'>distinct</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="timeline_for-instance_method">
  
    #<strong>timeline_for</strong>(entity_id, from: nil, to: nil)  &#x21d2; <tt><span class='object_link'><a href="../Temporal/Timeline.html" title="FactDb::Temporal::Timeline (class)">FactDb::Temporal::Timeline</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Builds a timeline of facts for an entity</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>entity_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the entity ID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>from</span>
      
      
        <span class='type'>(<tt>Date</tt>, <tt>Time</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>start of timeline range</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>to</span>
      
      
        <span class='type'>(<tt>Date</tt>, <tt>Time</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>end of timeline range</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Temporal/Timeline.html" title="FactDb::Temporal::Timeline (class)">FactDb::Temporal::Timeline</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>timeline of facts</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


266
267
268</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 266</span>

<span class='kw'>def</span> <span class='id identifier rubyid_timeline_for'>timeline_for</span><span class='lparen'>(</span><span class='id identifier rubyid_entity_id'>entity_id</span><span class='comma'>,</span> <span class='label'>from:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Temporal.html" title="FactDb::Temporal (module)">Temporal</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Temporal/Timeline.html" title="FactDb::Temporal::Timeline (class)">Timeline</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Temporal/Timeline.html#initialize-instance_method" title="FactDb::Temporal::Timeline#initialize (method)">new</a></span></span><span class='period'>.</span><span class='id identifier rubyid_build'><span class='object_link'><a href="../Temporal/Timeline.html#build-instance_method" title="FactDb::Temporal::Timeline#build (method)">build</a></span></span><span class='lparen'>(</span><span class='label'>entity_id:</span> <span class='id identifier rubyid_entity_id'>entity_id</span><span class='comma'>,</span> <span class='label'>from:</span> <span class='id identifier rubyid_from'>from</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='id identifier rubyid_to'>to</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="timespan_for-instance_method">
  
    #<strong>timespan_for</strong>(entity_id)  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the timespan of facts for an entity</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>entity_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Entity ID</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Hash with :from and :to dates</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


323
324
325
326
327
328
329
330
331
332</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/fact_db/services/entity_service.rb', line 323</span>

<span class='kw'>def</span> <span class='id identifier rubyid_timespan_for'>timespan_for</span><span class='lparen'>(</span><span class='id identifier rubyid_entity_id'>entity_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_facts'>facts</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Models.html" title="FactDb::Models (module)">Models</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Models/Fact.html" title="FactDb::Models::Fact (class)">Fact</a></span></span>
    <span class='period'>.</span><span class='id identifier rubyid_joins'>joins</span><span class='lparen'>(</span><span class='symbol'>:entity_mentions</span><span class='rparen'>)</span>
    <span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>entity_mentions:</span> <span class='lbrace'>{</span> <span class='label'>entity_id:</span> <span class='id identifier rubyid_entity_id'>entity_id</span> <span class='rbrace'>}</span><span class='rparen'>)</span>

  <span class='lbrace'>{</span>
    <span class='label'>from:</span> <span class='id identifier rubyid_facts'>facts</span><span class='period'>.</span><span class='id identifier rubyid_minimum'>minimum</span><span class='lparen'>(</span><span class='symbol'>:valid_at</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>to:</span> <span class='id identifier rubyid_facts'>facts</span><span class='period'>.</span><span class='id identifier rubyid_maximum'>maximum</span><span class='lparen'>(</span><span class='symbol'>:valid_at</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='const'>Date</span><span class='period'>.</span><span class='id identifier rubyid_today'>today</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Jan 13 02:43:38 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-3.3.10).
</div>

    </div>
  </body>
</html>